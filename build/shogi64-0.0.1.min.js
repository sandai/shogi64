/**
 * shogi64.js v0.0.1
 *
 * Copyright (c) 2015 sandai <sandai310@gmail.com>
 * Released under the MIT license
 */

var shogi64=function(r){function t(o){if(n[o])return n[o].exports;var i=n[o]={exports:{},id:o,loaded:!1};return r[o].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var n={};return t.m=r,t.c=n,t.p="",t(0)}([function(r,t,n){"use strict";function o(r){return"[object Array]"===Object.prototype.toString.call(r)}function i(r){if("boolean"!=typeof r.turn)return!1;if(o(r.board)!==!0)return!1;for(var t=0,n=r.board.length;n>t;t++)if(-14>r.board[t]&&14<r.board[t])return!1;if(81!==t)return!1;for(var i in r.hands){if("black"!==i&&"white"!==i)return!1;for(var e in r.hands[i])if(w[e]!==e||isNaN(r.hands[i][e])===!0)return!1}return!0}function e(r){return/^[A-Za-z0-9\-\_]+$/.test(r)}function a(r){return r.length>=6&&/^[01]+$/.test(r)}function s(r){return Number(r)}function f(r){for(var t=0,n=0,o=0,i=0,e=9;e>=1;e--){o=0,i=0;for(var a=1;9>=a;a++){if(1===a&&1===r[9*a-e]||9===a&&-1===r[9*a-e])return 1;switch(r[9*a-e]){case 8:t+=1;break;case-8:n+=1;break;case 1:o+=1;break;case-1:i+=1}if(o>1||i>1)return"1"}}return t>1||n>1?"1":"0"}function h(r,t){var n="",o="0"===t?l:v;"0"===t&&(n+=function(){for(var t="0000000",n="0000000",o="",i=0,e=r.length;e>i;i++)o=("00000000"+(i+1).toString(2)).slice(-7),8===r[i]?t=o:-8===r[i]&&(n=o);return t+n}(),n+=function(){for(var t,n,o=[],i=[],e=9;e>=1;e--){t="",n="";for(var a=1;9>=a;a++)1===r[9*a-e]?t=g[a]:-1===r[9*a-e]&&(n=g[10-a]);o.push(""===t?g[0]:t),i.push(""===n?g[0]:n)}return o.join("")+i.join("")}());for(var i=0,e=r.length;e>i;i++)void 0!==o[r[i]]&&(n+=o[r[i]]);return n}function u(r){for(var t="",n=["black","white"],o=0,i=n.length;i>o;o++)for(var e in r[n[o]])"FU"===e?t+=b.FU[r[n[o]][e]]:"KY"===e||"KE"===e||"GI"===e||"KI"===e?t+=b.KOGOMA[r[n[o]][e]]:("KA"===e||"HI"===e)&&(t+=b.OGOMA[r[n[o]][e]]);return t}function c(r){this.bits=r,this.len=r.length,this.index=0}var d={};d.table="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";var l={0:"0",2:"1001","-2":"1000",5:"1011","-5":"1010",3:"11001","-3":"11000",4:"11011","-4":"11010",7:"11101","-7":"11100",6:"111101","-6":"111100",13:"11111001","-13":"11111000",14:"11111011","-14":"11111010",9:"11111101","-9":"11111100",11:"111111101","-11":"111111100",12:"1111111101","-12":"1111111100",10:"1111111111","-10":"1111111110"},v={0:"0",1:"101","-1":"100",2:"11001","-2":"11000",5:"11011","-5":"11010",3:"111001","-3":"111000",4:"111101","-4":"111100",8:"1110101","-8":"1110100",7:"1110111","-7":"1110110",6:"1111101","-6":"1111100",13:"111111001","-13":"111111000",14:"111111011","-14":"111111010",9:"111111101","-9":"111111100",11:"1111111101","-11":"1111111100",12:"11111111101","-12":"11111111100",10:"11111111111","-10":"11111111110"},g={7:"0",6:"10",0:"110",5:"1110",4:"11110",8:"111110",3:"1111110",9:"11111110",2:"11111111"},b={FU:["00","01","10","110","1110","11110","111110","1111110","11111110","111111110","1111111110","11111111110","111111111110","1111111111110","11111111111110","111111111111110","1111111111111110","11111111111111110","11111111111111111"],KOGOMA:["0","10","110","1110","1111"],OGOMA:["0","10","11"]},w={FU:"FU",KY:"KY",KE:"KE",GI:"GI",KI:"KI",KA:"KA",HI:"HI"};d.encodeBoardToBits=function(r){if(i(r)===!1)throw new Error("board is invalid.");var t=f(r.board);return s(r.turn)+t+h(r.board,t)+u(r.hands)},d.encodeBitsToShogi64=function(r){if(a(r)===!1)throw new Error("bits string is invalid.");var t="",n=function(r){for(var t={},n=0,o=r.length;o>n;n++)t[("00000000"+n.toString(2)).slice(-6)]=r.charAt(n);return t}(this.table);r.length%6!==0&&(r=(r+"000000").slice(0,-(r.length%6)));for(var o=0,i=r.length/6;i>0;o+=6,i--)t+=n[r.substr(o,6)];return t},d.encode=function(r){if(i(r)===!1)throw new Error("board is invalid.");return this.encodeBitsToShogi64(this.encodeBoardToBits(r))},d.decodeShogi64ToBits=function(r){if(e(r)===!1)throw new Error("shogi64 string is invalid.");for(var t="",n=function(r){for(var t={},n=0,o=r.length;o>n;n++)t[r.charAt(n)]=("00000000"+n.toString(2)).slice(-6);return t}(this.table),o=0,i=r.length;i>o;o++)t+=n[r[o]];return t},c.prototype.letter=function(){var r=this.bits[this.index];return this.index+=1,r},c.prototype.range=function(r){var t=this.bits.substr(this.index,r);return this.index+=r,t},c.prototype.checkOverFlow=function(){return this.len<this.index};var p=function(r){var t={};for(var n in r)t[r[n]]=n;return t}(g),K=function(r){var t={},n={};for(var o in r){n[o]={};for(var i=0,e=r[o].length;e>i;i++)n[o][r[o][i]]=i}for(var a in w)"FU"===a?t[a]=n.FU:"KY"===a||"KE"===a||"GI"===a||"KI"===a?t[a]=n.KOGOMA:("KA"===a||"HI"===a)&&(t[a]=n.OGOMA);return t}(b);d.decodeBitsToBoard=function(r){var t,n,o={turn:null,board:[],hands:{}},i=97,e=["black","white"],a=new c(r),s="",f=null,h={};for(t=0;81>t;t++)o.board[t]=0;if(o.turn=Boolean(parseInt(a.letter(),10)),i-=1,f=Boolean(parseInt(a.letter(),10)),i-=1,f===!1){var u;for(t=0,n=e.length;n>t;t++){if(s=a.range(7),a.checkOverFlow()===!0)throw new Error("shogi64 string is invalid.");u=parseInt(s,2)-1,u>0&&(o.board[u]="black"===e[t]?8:-8,i-=1)}var d;for(t=0,n=e.length;n>t;t++)for(var g=9;g>=1;g--){for(s="";void 0===p[s];)if(s+=a.letter(),a.checkOverFlow()===!0)throw new Error("shogi64 string is invalid.");d=p[s],"0"!==d&&("black"===e[t]?o.board[9*d-g]=1:"white"===e[t]&&(o.board[9*(10-d)-g]=-1),i-=1)}}for(h=function(r){var t={};for(var n in r)t[r[n]]=n;return t}(f===!0?v:l),t=0,n=o.board.length;n>t;t++)if(0===o.board[t]){for(s="";void 0===h[s];)if(s+=a.letter(),a.checkOverFlow()===!0)throw new Error("shogi64 string is invalid.");o.board[t]=parseInt(h[s],10),i-=1}for(t=0,n=e.length;n>t;t++){o.hands[e[t]]={};for(var b in K){for(s="";void 0===K[b][s];)if(s+=a.letter(),a.checkOverFlow()===!0)throw new Error("shogi64 string is invalid.");o.hands[e[t]][b]=K[b][s],i-=1}}if(0!==i)throw new Error("shogi64 string is invalid.");return o},d.decode=function(r){if(e(r)===!1)throw new Error("shogi64 string is invalid.");return this.decodeBitsToBoard(this.decodeShogi64ToBits(r))},r.exports=d}]);